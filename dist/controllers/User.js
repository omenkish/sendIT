"use strict";

var cov_2hhazphapa = function () {
  var path = "C:\\Users\\Eneojo\\Desktop\\Branches\\develop\\server\\controllers\\User.js",
      hash = "8b9ed01d73335eaa9a05e68653d491304eb14c7d",
      Function = function () {}.constructor,
      global = new Function('return this')(),
      gcv = "__coverage__",
      coverageData = {
    path: "C:\\Users\\Eneojo\\Desktop\\Branches\\develop\\server\\controllers\\User.js",
    statementMap: {
      "0": {
        start: {
          line: 15,
          column: 25
        },
        end: {
          line: 15,
          column: 67
        }
      },
      "1": {
        start: {
          line: 17,
          column: 20
        },
        end: {
          line: 19,
          column: 18
        }
      },
      "2": {
        start: {
          line: 20,
          column: 19
        },
        end: {
          line: 27,
          column: 5
        }
      },
      "3": {
        start: {
          line: 29,
          column: 4
        },
        end: {
          line: 39,
          column: 5
        }
      },
      "4": {
        start: {
          line: 30,
          column: 23
        },
        end: {
          line: 30,
          column: 54
        }
      },
      "5": {
        start: {
          line: 31,
          column: 20
        },
        end: {
          line: 31,
          column: 67
        }
      },
      "6": {
        start: {
          line: 32,
          column: 6
        },
        end: {
          line: 32,
          column: 133
        }
      },
      "7": {
        start: {
          line: 35,
          column: 6
        },
        end: {
          line: 37,
          column: 7
        }
      },
      "8": {
        start: {
          line: 36,
          column: 8
        },
        end: {
          line: 36,
          column: 110
        }
      },
      "9": {
        start: {
          line: 38,
          column: 6
        },
        end: {
          line: 38,
          column: 62
        }
      },
      "10": {
        start: {
          line: 50,
          column: 4
        },
        end: {
          line: 52,
          column: 5
        }
      },
      "11": {
        start: {
          line: 51,
          column: 6
        },
        end: {
          line: 51,
          column: 95
        }
      },
      "12": {
        start: {
          line: 53,
          column: 4
        },
        end: {
          line: 55,
          column: 5
        }
      },
      "13": {
        start: {
          line: 54,
          column: 6
        },
        end: {
          line: 54,
          column: 108
        }
      },
      "14": {
        start: {
          line: 56,
          column: 21
        },
        end: {
          line: 56,
          column: 59
        }
      },
      "15": {
        start: {
          line: 58,
          column: 4
        },
        end: {
          line: 70,
          column: 5
        }
      },
      "16": {
        start: {
          line: 59,
          column: 23
        },
        end: {
          line: 59,
          column: 69
        }
      },
      "17": {
        start: {
          line: 60,
          column: 6
        },
        end: {
          line: 62,
          column: 7
        }
      },
      "18": {
        start: {
          line: 61,
          column: 8
        },
        end: {
          line: 61,
          column: 114
        }
      },
      "19": {
        start: {
          line: 63,
          column: 6
        },
        end: {
          line: 65,
          column: 7
        }
      },
      "20": {
        start: {
          line: 64,
          column: 8
        },
        end: {
          line: 64,
          column: 100
        }
      },
      "21": {
        start: {
          line: 66,
          column: 20
        },
        end: {
          line: 66,
          column: 67
        }
      },
      "22": {
        start: {
          line: 67,
          column: 6
        },
        end: {
          line: 67,
          column: 83
        }
      },
      "23": {
        start: {
          line: 69,
          column: 6
        },
        end: {
          line: 69,
          column: 78
        }
      },
      "24": {
        start: {
          line: 81,
          column: 26
        },
        end: {
          line: 81,
          column: 47
        }
      },
      "25": {
        start: {
          line: 82,
          column: 4
        },
        end: {
          line: 88,
          column: 5
        }
      },
      "26": {
        start: {
          line: 83,
          column: 33
        },
        end: {
          line: 83,
          column: 61
        }
      },
      "27": {
        start: {
          line: 84,
          column: 6
        },
        end: {
          line: 84,
          column: 83
        }
      },
      "28": {
        start: {
          line: 87,
          column: 6
        },
        end: {
          line: 87,
          column: 70
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 14,
            column: 2
          },
          end: {
            line: 14,
            column: 3
          }
        },
        loc: {
          start: {
            line: 14,
            column: 45
          },
          end: {
            line: 40,
            column: 3
          }
        },
        line: 14
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 49,
            column: 2
          },
          end: {
            line: 49,
            column: 3
          }
        },
        loc: {
          start: {
            line: 49,
            column: 39
          },
          end: {
            line: 72,
            column: 3
          }
        },
        line: 49
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 80,
            column: 2
          },
          end: {
            line: 80,
            column: 3
          }
        },
        loc: {
          start: {
            line: 80,
            column: 43
          },
          end: {
            line: 89,
            column: 3
          }
        },
        line: 80
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 35,
            column: 6
          },
          end: {
            line: 37,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 35,
            column: 6
          },
          end: {
            line: 37,
            column: 7
          }
        }, {
          start: {
            line: 35,
            column: 6
          },
          end: {
            line: 37,
            column: 7
          }
        }],
        line: 35
      },
      "1": {
        loc: {
          start: {
            line: 50,
            column: 4
          },
          end: {
            line: 52,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 50,
            column: 4
          },
          end: {
            line: 52,
            column: 5
          }
        }, {
          start: {
            line: 50,
            column: 4
          },
          end: {
            line: 52,
            column: 5
          }
        }],
        line: 50
      },
      "2": {
        loc: {
          start: {
            line: 50,
            column: 7
          },
          end: {
            line: 50,
            column: 52
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 50,
            column: 7
          },
          end: {
            line: 50,
            column: 26
          }
        }, {
          start: {
            line: 50,
            column: 30
          },
          end: {
            line: 50,
            column: 52
          }
        }],
        line: 50
      },
      "3": {
        loc: {
          start: {
            line: 53,
            column: 4
          },
          end: {
            line: 55,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 53,
            column: 4
          },
          end: {
            line: 55,
            column: 5
          }
        }, {
          start: {
            line: 53,
            column: 4
          },
          end: {
            line: 55,
            column: 5
          }
        }],
        line: 53
      },
      "4": {
        loc: {
          start: {
            line: 60,
            column: 6
          },
          end: {
            line: 62,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 60,
            column: 6
          },
          end: {
            line: 62,
            column: 7
          }
        }, {
          start: {
            line: 60,
            column: 6
          },
          end: {
            line: 62,
            column: 7
          }
        }],
        line: 60
      },
      "5": {
        loc: {
          start: {
            line: 63,
            column: 6
          },
          end: {
            line: 65,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 63,
            column: 6
          },
          end: {
            line: 65,
            column: 7
          }
        }, {
          start: {
            line: 63,
            column: 6
          },
          end: {
            line: 65,
            column: 7
          }
        }],
        line: 63
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0, 0],
      "3": [0, 0],
      "4": [0, 0],
      "5": [0, 0]
    },
    _coverageSchema: "43e27e138ebf9cfc5966b082cf9a028302ed4184"
  },
      coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  coverageData.hash = hash;
  return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _helper = _interopRequireDefault(require("../helpers/helper"));

require("@babel/polyfill");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var User =
/*#__PURE__*/
function () {
  function User() {
    _classCallCheck(this, User);
  }

  _createClass(User, null, [{
    key: "createUser",

    /**
    * Create A User
    * @param {object} request 
    * @param {object} response
    * @returns {object} user object 
    */
    value: function () {
      var _createUser = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee(request, response) {
        var hashPassword, sqltext, values, _ref, rows, token;

        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                cov_2hhazphapa.f[0]++;
                hashPassword = (cov_2hhazphapa.s[0]++, _helper.default.hashPassword(request.body.password));
                sqltext = (cov_2hhazphapa.s[1]++, "INSERT INTO users(firstname, lastname, othernames, email, phone, password)\n      VALUES($1, $2, $3, $4, $5, $6)\n      returning *");
                values = (cov_2hhazphapa.s[2]++, [request.body.firstname.toLowerCase(), request.body.lastname.toLowerCase(), request.body.othernames.toLowerCase(), request.body.email.toLowerCase(), request.body.phone, hashPassword]);
                cov_2hhazphapa.s[3]++;
                _context.prev = 5;
                cov_2hhazphapa.s[4]++;
                _context.next = 9;
                return _db.default.query(sqltext, values);

              case 9:
                _ref = _context.sent;
                rows = _ref.rows;
                token = (cov_2hhazphapa.s[5]++, _helper.default.generateToken(rows[0].email, rows[0].id));
                cov_2hhazphapa.s[6]++;
                return _context.abrupt("return", response.status(201).json("{'Status': '201','Message': 'Signup successful. Please copy your token','Token': ".concat(token, "}")));

              case 16:
                _context.prev = 16;
                _context.t0 = _context["catch"](5);
                cov_2hhazphapa.s[7]++;

                if (!(_context.t0.routine === '_bt_check_unique')) {
                  _context.next = 25;
                  break;
                }

                cov_2hhazphapa.b[0][0]++;
                cov_2hhazphapa.s[8]++;
                return _context.abrupt("return", response.status(400).json({
                  'Status': '400',
                  'message': 'User with that EMAIL already exists'
                }));

              case 25:
                cov_2hhazphapa.b[0][1]++;

              case 26:
                cov_2hhazphapa.s[9]++;
                return _context.abrupt("return", response.status(400).json({
                  'Error': "".concat(_context.t0)
                }));

              case 28:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this, [[5, 16]]);
      }));

      return function createUser(_x, _x2) {
        return _createUser.apply(this, arguments);
      };
    }()
    /**
     * Login
     * @param {object} request
     * @param {object} response
     * @returns {object} user object 
     */

  }, {
    key: "login",
    value: function () {
      var _login = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee2(request, response) {
        var sqlQuery, _ref2, rows, token;

        return regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                cov_2hhazphapa.f[1]++;
                cov_2hhazphapa.s[10]++;

                if (!((cov_2hhazphapa.b[2][0]++, !request.body.email) || (cov_2hhazphapa.b[2][1]++, !request.body.password))) {
                  _context2.next = 8;
                  break;
                }

                cov_2hhazphapa.b[1][0]++;
                cov_2hhazphapa.s[11]++;
                return _context2.abrupt("return", response.status(415).json({
                  'Status': '415',
                  'message': 'Some values are missing'
                }));

              case 8:
                cov_2hhazphapa.b[1][1]++;

              case 9:
                cov_2hhazphapa.s[12]++;

                if (_helper.default.isValidEmail(request.body.email)) {
                  _context2.next = 16;
                  break;
                }

                cov_2hhazphapa.b[3][0]++;
                cov_2hhazphapa.s[13]++;
                return _context2.abrupt("return", response.status(400).json({
                  'Status': '400',
                  'message': 'Please enter a valid email address'
                }));

              case 16:
                cov_2hhazphapa.b[3][1]++;

              case 17:
                sqlQuery = (cov_2hhazphapa.s[14]++, 'SELECT * FROM users WHERE email = $1');
                cov_2hhazphapa.s[15]++;
                _context2.prev = 19;
                cov_2hhazphapa.s[16]++;
                _context2.next = 23;
                return _db.default.query(sqlQuery, [request.body.email]);

              case 23:
                _ref2 = _context2.sent;
                rows = _ref2.rows;
                cov_2hhazphapa.s[17]++;

                if (rows[0]) {
                  _context2.next = 32;
                  break;
                }

                cov_2hhazphapa.b[4][0]++;
                cov_2hhazphapa.s[18]++;
                return _context2.abrupt("return", response.status(400).json({
                  'Status': '400',
                  'message': 'The credentials you provided is incorrect'
                }));

              case 32:
                cov_2hhazphapa.b[4][1]++;

              case 33:
                cov_2hhazphapa.s[19]++;

                if (_helper.default.comparePassword(rows[0].password, request.body.password)) {
                  _context2.next = 40;
                  break;
                }

                cov_2hhazphapa.b[5][0]++;
                cov_2hhazphapa.s[20]++;
                return _context2.abrupt("return", response.status(400).json({
                  'Status': '400',
                  'Message': 'This password is incorrect'
                }));

              case 40:
                cov_2hhazphapa.b[5][1]++;

              case 41:
                token = (cov_2hhazphapa.s[21]++, _helper.default.generateToken(rows[0].email, rows[0].id));
                cov_2hhazphapa.s[22]++;
                return _context2.abrupt("return", response.status(200).json({
                  'Status': 200,
                  'Copy this TOKEN ': token
                }));

              case 46:
                _context2.prev = 46;
                _context2.t0 = _context2["catch"](19);
                cov_2hhazphapa.s[23]++;
                return _context2.abrupt("return", response.status(400).json("{'Status': '400','Error': ".concat(_context2.t0, "}")));

              case 50:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this, [[19, 46]]);
      }));

      return function login(_x3, _x4) {
        return _login.apply(this, arguments);
      };
    }()
    /**
     * 
     * @param {object} request 
     * @param {object} response 
     * @returns {Array} users
     */

  }, {
    key: "getUsers",
    value: function () {
      var _getUsers = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee3(request, response) {
        var findUsersSql, _ref3, rows, rowCount;

        return regeneratorRuntime.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                cov_2hhazphapa.f[2]++;
                findUsersSql = (cov_2hhazphapa.s[24]++, 'SELECT * FROM users');
                cov_2hhazphapa.s[25]++;
                _context3.prev = 3;
                cov_2hhazphapa.s[26]++;
                _context3.next = 7;
                return _db.default.query(findUsersSql);

              case 7:
                _ref3 = _context3.sent;
                rows = _ref3.rows;
                rowCount = _ref3.rowCount;
                cov_2hhazphapa.s[27]++;
                return _context3.abrupt("return", response.status(200).json({
                  'Data': rows,
                  'Rows Affected': rowCount
                }));

              case 14:
                _context3.prev = 14;
                _context3.t0 = _context3["catch"](3);
                cov_2hhazphapa.s[28]++;
                response.status(400).json({
                  'Status': 400,
                  'Error': "".concat(_context3.t0, "}")
                });

              case 18:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this, [[3, 14]]);
      }));

      return function getUsers(_x5, _x6) {
        return _getUsers.apply(this, arguments);
      };
    }()
  }]);

  return User;
}();

var _default = User;
exports.default = _default;